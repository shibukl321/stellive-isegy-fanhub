<!doctype html>
}catch(e){ by('me').innerHTML = `<span class="err">오류:</span> ${esc(e)}`; }
}


async function me(){
try{
const r = await fetch(BASE()+'/me', { ...cred });
if(!r.ok){ by('auth-area').innerHTML = '<div class="muted">로그인 필요</div>'; return; }
const j = await r.json();
if(j.ok){
by('auth-area').innerHTML = `<div class="row" style="align-items:center"><img src="${esc(j.user.picture||'')}" onerror="this.style.display='none'" style="width:28px;height:28px;border-radius:50%"> <span>${esc(j.user.name)}</span> ${j.user.admin?'<span class="pill">관리자</span>':''} <button class="btn sec" onclick="logout()">로그아웃</button></div>`;
diaryList(); confessionList();
}
}catch{}
}


async function logout(){
await fetch(BASE()+'/logout', { method:'POST', ...cred });
by('auth-area').innerHTML = '<div class="muted">로그인 필요</div>';
by('me').textContent = '';
}


// vote
async function vote(){
const memberId = by('member').value;
const r = await fetch(BASE()+'/vote', { method:'POST', headers, body: JSON.stringify({ memberId }), ...cred });
const j = await r.json();
by('voteMsg').innerHTML = j.ok? `<span class="ok">✅ 투표 완료:</span> ${esc(memberId)} (${esc(j.month)})` : `<span class="err">❌ ${esc(j.error)}</span>`;
}
async function voteResults(){
const r = await fetch(BASE()+'/vote/results', { ...cred });
const j = await r.json();
if(!j.ok){ by('voteResult').textContent = '불러오기 실패'; return; }
const out = Object.entries(j.counts||{}).sort((a,b)=>b[1]-a[1]).map(([k,v])=>`<div class="row"><span class="pill">${esc(k)}</span> <b>${v}</b></div>`).join('');
by('voteResult').innerHTML = out || '<span class="muted">아직 집계 없음</span>';
}


// diary
async function diaryList(){
const r = await fetch(BASE()+'/diary', { ...cred });
if(!r.ok){ by('diaryList').innerHTML = '<span class="muted">로그인 필요</span>'; return; }
const j = await r.json();
if(!j.ok){ by('diaryList').textContent = '불러오기 실패'; return; }
by('diaryList').innerHTML = (j.items||[]).map(it=>`<div class="card" style="padding:10px"><div class="muted">${new Date(it.ts).toLocaleString()}</div><div>${esc(it.text)}</div><div class="row" style="margin-top:6px"><button class="btn danger" onclick="diaryDel('${esc(it.id)}')">삭제</button></div></div>`).join('');
}
async function diaryAdd(){
const text = by('diaryText').value.trim();
if(!text){ alert('내용을 입력해 주세요'); return; }
const r = await fetch(BASE()+'/diary', { method:'POST', headers, body: JSON.stringify({ text }), ...cred });
const j = await r.json();
if(j.ok){ by('diaryText').value=''; diaryList(); }
}
async function diaryDel(id){
await fetch(BASE()+'/diary/'+encodeURIComponent(id), { method:'DELETE', ...cred });
diaryList();
}


// confessions
async function confessionList(){
const r = await fetch(BASE()+'/confessions', { ...cred });
const j = await r.json();
if(!j.ok){ by('confList').textContent = '불러오기 실패'; return; }
by('confList').innerHTML = (j.items||[]).map(it=>`<div class="card" style="padding:10px"><div class="muted">${new Date(it.ts).toLocaleString()}</div><div>${esc(it.text)}</div><div class="row" style="margin-top:6px"><button class="btn danger" onclick="confDel('${esc(it.id)}')">관리자 삭제</button></div></div>`).join('');
}
async function confessionAdd(){
const text = by('confText').value.trim();
if(!text){ alert('내용을 입력해 주세요'); return; }
const r = await fetch(BASE()+'/confessions', { method:'POST', headers, body: JSON.stringify({ text }), ...cred });
const j = await r.json(); if(j.ok){ by('confText').value=''; confessionList(); }
}
async function confDel(id){
const r = await fetch(BASE()+'/confessions/'+encodeURIComponent(id), { method:'DELETE', ...cred });
if(r.status===403) alert('관리자만 삭제할 수 있습니다');
confessionList();
}
</script>
</body>
</html>
